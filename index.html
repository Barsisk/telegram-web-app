<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–∫–∞–∑ —Å–ø—Ä–∞–≤–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #222222);
            margin: 0;
            padding: 16px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: var(--tg-theme-text-color, #222222);
            margin-bottom: 24px;
            font-size: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--tg-theme-text-color, #222222);
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 10px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #222222);
            font-size: 16px;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }
        
        .period-container {
            display: none;
            gap: 10px;
        }
        
        .period-container.visible {
            display: flex;
        }
        
        .period-container input {
            flex: 1;
        }
        
        button {
            width: 100%;
            padding: 14px;
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
        }
        
        button:disabled {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-hint-color, #999999);
            cursor: not-allowed;
        }
        
        .error {
            color: #ff3b30;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .error.visible {
            display: block;
        }
        
        .success {
            text-align: center;
            color: #34c759;
            font-size: 16px;
            margin-top: 20px;
            display: none;
        }
        
        .success.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã –ó–∞–∫–∞–∑ —Å–ø—Ä–∞–≤–∫–∏</h1>
        
        <form id="certificateForm">
            <div class="form-group">
                <label for="fullName">–§–ò–û:</label>
                <input type="text" id="fullName" required>
                <div class="error" id="fullNameError">–ü–æ–ª–µ –§–ò–û –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
            </div>
            
            <div class="form-group">
                <label for="building">–ö–æ—Ä–ø—É—Å:</label>
                <select id="building" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–ø—É—Å</option>
                    <option value="–ì–ª–∞–≤–Ω—ã–π">–ì–ª–∞–≤–Ω—ã–π –∫–æ—Ä–ø—É—Å</option>
                    <option value="–ü–µ—Ä–≤—ã–π">–ü–µ—Ä–≤—ã–π –∫–æ—Ä–ø—É—Å</option>
                    <option value="–í—Ç–æ—Ä–æ–π">–í—Ç–æ—Ä–æ–π –∫–æ—Ä–ø—É—Å</option>
                </select>
                <div class="error" id="buildingError">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–ø—É—Å</div>
            </div>
            
            <div class="form-group">
                <label for="groupName">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</label>
                <input type="text" id="groupName" required>
                <div class="error" id="groupNameError">–ü–æ–ª–µ –≥—Ä—É–ø–ø—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
            </div>
            
            <div class="form-group">
                <label for="certificateType">–í–∏–¥ —Å–ø—Ä–∞–≤–∫–∏:</label>
                <select id="certificateType" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ —Å–ø—Ä–∞–≤–∫–∏</option>
                    <option value="–æ –æ–±—É—á–µ–Ω–∏–∏">–°–ø—Ä–∞–≤–∫–∞ –æ–± –æ–±—É—á–µ–Ω–∏–∏</option>
                    <option value="–æ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏">–°–ø—Ä–∞–≤–∫–∞ –æ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏</option>
                </select>
                <div class="error" id="certificateTypeError">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ —Å–ø—Ä–∞–≤–∫–∏</div>
            </div>
            
            <div class="form-group">
                <div class="period-container" id="periodContainer">
                    <div>
                        <label for="periodFrom">–°:</label>
                        <input type="date" id="periodFrom">
                    </div>
                    <div>
                        <label for="periodTo">–ü–æ:</label>
                        <input type="date" id="periodTo">
                    </div>
                </div>
                <div class="error" id="periodError">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏ –æ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏</div>
            </div>
            
            <div class="form-group">
                <label for="quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫ (1-5):</label>
                <input type="number" id="quantity" min="1" max="5" value="1" required>
                <div class="error" id="quantityError">–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 5</div>
            </div>
            
            <button type="submit" id="submitBtn">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </form>
        
        <div class="success" id="successMessage">
            ‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const form = document.getElementById('certificateForm');
        const certificateType = document.getElementById('certificateType');
        const periodContainer = document.getElementById('periodContainer');
        const quantityInput = document.getElementById('quantity');
        const submitBtn = document.getElementById('submitBtn');
        const successMessage = document.getElementById('successMessage');
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª—è –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è —Å—Ç–∏–ø–µ–Ω–¥–∏–∏
        certificateType.addEventListener('change', function() {
            if (this.value === '–æ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏') {
                periodContainer.classList.add('visible');
            } else {
                periodContainer.classList.remove('visible');
            }
        });
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        quantityInput.addEventListener('input', function() {
            const value = parseInt(this.value);
            if (value < 1) this.value = 1;
            if (value > 5) this.value = 5;
        });
        
        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –§–ò–û –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function prefillUserData() {
            const user = tg.initDataUnsafe?.user;
            if (user) {
                let fullName = '';
                if (user.last_name && user.first_name) {
                    fullName = `${user.last_name} ${user.first_name}`;
                } else if (user.first_name) {
                    fullName = user.first_name;
                } else if (user.username) {
                    fullName = user.username;
                }
                
                if (fullName) {
                    document.getElementById('fullName').value = fullName;
                }
            }
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        function validateForm() {
            let isValid = true;
            
            // –°–±—Ä–æ—Å –æ—à–∏–±–æ–∫
            document.querySelectorAll('.error').forEach(el => el.classList.remove('visible'));
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –§–ò–û
            const fullName = document.getElementById('fullName').value.trim();
            if (!fullName) {
                document.getElementById('fullNameError').classList.add('visible');
                isValid = false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä–ø—É—Å–∞
            const building = document.getElementById('building').value;
            if (!building) {
                document.getElementById('buildingError').classList.add('visible');
                isValid = false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä—É–ø–ø—ã
            const groupName = document.getElementById('groupName').value.trim();
            if (!groupName) {
                document.getElementById('groupNameError').classList.add('visible');
                isValid = false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Å–ø—Ä–∞–≤–∫–∏
            const certType = document.getElementById('certificateType').value;
            if (!certType) {
                document.getElementById('certificateTypeError').classList.add('visible');
                isValid = false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è —Å—Ç–∏–ø–µ–Ω–¥–∏–∏
            if (certType === '–æ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏') {
                const periodFrom = document.getElementById('periodFrom').value;
                const periodTo = document.getElementById('periodTo').value;
                if (!periodFrom || !periodTo) {
                    document.getElementById('periodError').classList.add('visible');
                    isValid = false;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            const quantity = parseInt(quantityInput.value);
            if (isNaN(quantity) || quantity < 1 || quantity > 5) {
                document.getElementById('quantityError').classList.add('visible');
                isValid = false;
            }
            
            return isValid;
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) return;
            
            submitBtn.disabled = true;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            const formData = {
                user_id: tg.initDataUnsafe?.user?.id || 0,
                full_name: document.getElementById('fullName').value.trim(),
                building: document.getElementById('building').value,
                group_name: document.getElementById('groupName').value.trim(),
                certificate_type: document.getElementById('certificateType').value,
                quantity: parseInt(quantityInput.value)
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–∏–æ–¥ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏ –æ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏
            if (formData.certificate_type === '–æ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏') {
                formData.period_from = document.getElementById('periodFrom').value;
                formData.period_to = document.getElementById('periodTo').value;
            }
            
            try {
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Telegram Web App
                tg.sendData(JSON.stringify(formData));
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                form.style.display = 'none';
                successMessage.classList.add('visible');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    tg.close();
                }, 2000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
            }
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            prefillUserData();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('periodFrom').value = today;
            document.getElementById('periodTo').value = today;
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–∫–∞–∑ —Å–ø—Ä–∞–≤–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ... –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
        
        .access-denied {
            text-align: center;
            padding: 50px 20px;
            color: #ff3b30;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div class="container" id="form-container">
            <!-- ... –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–æ—Ä–º—ã –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... -->
        </div>
        
        <div class="access-denied" id="access-denied" style="display: none;">
            <h1>‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h1>
            <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç.</p>
        </div>
    </div>

    <script>
        function initApp() {
            if (typeof window.Telegram === 'undefined' || typeof window.Telegram.WebApp === 'undefined') {
                document.getElementById('form-container').style.display = 'none';
                document.getElementById('access-denied').style.display = 'block';
                return;
            }
    
            let tg = window.Telegram.WebApp;
            
            if (tg.platform === 'unknown') {
                document.getElementById('form-container').style.display = 'none';
                document.getElementById('access-denied').style.display = 'block';
                return;
            }
    
            tg.expand();
            tg.MainButton.hide();
            
            console.log('Successfully initialized in Telegram');
            
            const form = document.getElementById('certificateForm');
            const certificateType = document.getElementById('certificateType');
            const periodContainer = document.getElementById('periodContainer');
            const quantityInput = document.getElementById('quantity');
            const submitBtn = document.getElementById('submitBtn');
            const successMessage = document.getElementById('successMessage');
            const fullNameExample = document.getElementById('fullNameExample');
            
            function getFullNameFromInitData() {
                try {
                    const initData = new URLSearchParams(tg.initData);
                    const userStr = initData.get('user');
                    if (userStr) {
                        const user = JSON.parse(userStr);
                        if (user.first_name || user.last_name) {
                            return `${user.last_name || ''} ${user.first_name || ''}`.trim();
                        }
                    }
                } catch (e) {
                    console.error('Error parsing init data:', e);
                }
                return null;
            }

            function prefillFormData() {
                const fullName = getFullNameFromInitData();
                
                if (fullName) {
                    document.getElementById('fullName').value = fullName;
                    fullNameExample.style.display = 'none';
                }
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª—è –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è —Å—Ç–∏–ø–µ–Ω–¥–∏–∏
            certificateType.addEventListener('change', function() {
                if (this.value === '–æ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏') {
                    periodContainer.classList.add('visible');
                } else {
                    periodContainer.classList.remove('visible');
                }
            });

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            quantityInput.addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value < 1) this.value = 1;
                if (value > 5) this.value = 5;
            });

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
            function validateForm() {
                let isValid = true;
                
                document.querySelectorAll('.error').forEach(el => el.classList.remove('visible'));
                
                const fullName = document.getElementById('fullName').value.trim();
                if (!fullName) {
                    document.getElementById('fullNameError').classList.add('visible');
                    isValid = false;
                }
                
                const building = document.getElementById('building').value;
                if (!building) {
                    document.getElementById('buildingError').classList.add('visible');
                    isValid = false;
                }
                
                const groupName = document.getElementById('groupName').value.trim();
                if (!groupName) {
                    document.getElementById('groupNameError').classList.add('visible');
                    isValid = false;
                }
                
                const certType = document.getElementById('certificateType').value;
                if (!certType) {
                    document.getElementById('certificateTypeError').classList.add('visible');
                    isValid = false;
                }
                
                if (certType === '–æ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏') {
                    const periodFrom = document.getElementById('periodFrom').value;
                    const periodTo = document.getElementById('periodTo').value;
                    if (!periodFrom || !periodTo) {
                        document.getElementById('periodError').classList.add('visible');
                        isValid = false;
                    }
                }
                
                const quantity = parseInt(quantityInput.value);
                if (isNaN(quantity) || quantity < 1 || quantity > 5) {
                    document.getElementById('quantityError').classList.add('visible');
                    isValid = false;
                }
                
                return isValid;
            }

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!validateForm()) return;
                
                submitBtn.disabled = true;
                submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
                
                const formData = {
                    user_id: tg.initDataUnsafe?.user?.id || 0,
                    username: tg.initDataUnsafe?.user?.username || 'N/A',
                    full_name: document.getElementById('fullName').value.trim(),
                    building: document.getElementById('building').value,
                    group_name: document.getElementById('groupName').value.trim(),
                    certificate_type: document.getElementById('certificateType').value,
                    quantity: parseInt(quantityInput.value)
                };
                
                if (formData.certificate_type === '–æ —Å—Ç–∏–ø–µ–Ω–¥–∏–∏') {
                    formData.period_from = document.getElementById('periodFrom').value;
                    formData.period_to = document.getElementById('periodTo').value;
                }
                
                try {
                    tg.sendData(JSON.stringify(formData));
                    
                    form.style.display = 'none';
                    successMessage.classList.add('visible');
                    
                    setTimeout(() => {
                        tg.close();
                    }, 2000);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
                }
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            prefillFormData();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('periodFrom').value = today;
            document.getElementById('periodTo').value = today;
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
